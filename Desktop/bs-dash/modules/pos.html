<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BS Dash - Punto de Venta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-[#fbfbfb] min-h-screen">
    <header class="bs-card mx-4 mt-4 mb-6">
        <div class="flex items-center justify-between p-4">
            <div class="flex items-center gap-4">
                <a href="../dashboard.html" class="bs-btn">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center border border-green-200">
                        <i class="bi bi-cash-coin text-green-600"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">Punto de Venta</h1>
                        <p class="text-sm text-gray-600" id="fechaHora"></p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <span class="text-gray-700" id="userName">John Berroa</span>
                <button onclick="logout()" class="bs-btn bg-red-50 text-red-600 border-red-200">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Panel de Búsqueda y Productos -->
            <div class="lg:col-span-2">
                <div class="bs-card p-6 mb-6">
                    <!-- Información de la Venta -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <!-- Cliente -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                            <select id="selectCliente" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Seleccionar cliente...</option>
                            </select>
                        </div>
                        
                        <!-- Tipo de Facturación -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                            <select id="selectTipoFacturacion" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="Factura">Factura</option>
                            </select>
                        </div>
                        
                        <!-- Método de Pago -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Método de Pago</label>
                            <select id="selectMetodoPago" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="Efectivo">Efectivo</option>
                            </select>
                        </div>
                    </div>

                    <!-- Búsqueda -->
                    <div class="flex gap-4 mb-4">
                        <input type="text" id="buscarProducto" placeholder="Buscar producto por nombre o código..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                               onkeyup="buscarProductos()">
                        <button onclick="buscarProductos()" class="bs-btn">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                    
                    <!-- Lista de Productos -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="listaProductos">
                        <!-- Productos se cargan aquí con JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Carrito de Compras -->
            <div class="bs-card p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="bi bi-cart"></i> Carrito de Venta
                </h2>
                
                <!-- Descuento -->
                <div class="mb-4" id="descuentoContainer" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descuento (%)</label>
                    <input type="number" id="descuento" value="0" min="0" max="100" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                           onchange="actualizarTotales()">
                </div>
                
                <!-- Items del Carrito -->
                <div id="carrito" class="mb-4 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">El carrito está vacío</p>
                </div>
                
                <!-- Totales -->
                <div class="border-t pt-4 space-y-3">
                    <div class="flex justify-between">
                        <span class="font-medium">Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    
                    <div id="descuentoLinea" class="flex justify-between text-red-600" style="display: none;">
                        <span class="font-medium">Descuento:</span>
                        <span id="montoDescuento">-$0.00</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="font-medium">IVA (<span id="ivaPorcentaje">12</span>%):</span>
                        <span id="iva">$0.00</span>
                    </div>
                    
                    <div class="flex justify-between text-lg font-bold border-t pt-2">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                    
                    <!-- Botones de Acción -->
                    <div class="flex gap-2 mt-4">
                        <button onclick="limpiarCarrito()" class="bs-btn flex-1">
                            <i class="bi bi-trash"></i> Limpiar
                        </button>
                        <button onclick="procesarVenta()" class="bs-btn bs-btn-primary flex-1">
                            <i class="bi bi-credit-card"></i> Cobrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/database.js"></script>
    <script>
        // Verificar autenticación
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = '../index.html';
        }

        // Mostrar información
        document.getElementById('userName').textContent = localStorage.getItem('userName') || 'John Berroa';
        
        // Actualizar fecha y hora
        function actualizarFechaHora() {
            const ahora = new Date();
            document.getElementById('fechaHora').textContent = 
                ahora.toLocaleDateString('es-ES') + ' ' + ahora.toLocaleTimeString('es-ES');
        }
        setInterval(actualizarFechaHora, 1000);
        actualizarFechaHora();

        // Variables globales
        let carrito = [];
        let configuracion = {};

        // Cargar configuración y datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarConfiguracion();
            cargarClientes();
            cargarMetodosPago();
            cargarTiposFacturacion();
            cargarProductos();
        });

        function cargarConfiguracion() {
            configuracion = JSON.parse(localStorage.getItem('bsdash_configuracion') || '{}');
            
            // Mostrar/ocultar descuentos según configuración
            const descuentoContainer = document.getElementById('descuentoContainer');
            const solicitarCliente = document.getElementById('selectCliente').closest('div');
            
            if (configuracion.habilitarDescuentos) {
                descuentoContainer.style.display = 'block';
            }
            
            if (!configuracion.solicitarCliente) {
                solicitarCliente.style.display = 'none';
            }
            
            // Actualizar IVA
            document.getElementById('ivaPorcentaje').textContent = configuracion.ivaPorDefecto || 12;
        }

        function cargarClientes() {
            const clientes = db.getClientes();
            const select = document.getElementById('selectCliente');
            select.innerHTML = '<option value="">Seleccionar cliente...</option>';
            
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = `${cliente.nombre} (${cliente.ruc_ci})`;
                select.appendChild(option);
            });
        }

        function cargarMetodosPago() {
            const metodosPago = JSON.parse(localStorage.getItem('bsdash_metodosPago') || '["Efectivo", "Tarjeta Débito", "Tarjeta Crédito", "Transferencia"]');
            const select = document.getElementById('selectMetodoPago');
            select.innerHTML = '';
            
            metodosPago.forEach(metodo => {
                const option = document.createElement('option');
                option.value = metodo;
                option.textContent = metodo;
                select.appendChild(option);
            });
        }

        function cargarTiposFacturacion() {
            const tiposFacturacion = JSON.parse(localStorage.getItem('bsdash_tiposFacturacion') || '["Factura", "Boleta de Venta", "Liquidación de Compra"]');
            const select = document.getElementById('selectTipoFacturacion');
            select.innerHTML = '';
            
            tiposFacturacion.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo;
                option.textContent = tipo;
                select.appendChild(option);
            });
        }

        // El resto de las funciones (cargarProductos, buscarProductos, agregarAlCarrito, etc.)
        // se mantienen igual que en la versión anterior...

        // [Aquí irían todas las funciones del carrito que ya tienes...]
        // Solo necesitas agregar las nuevas funciones de configuración arriba

        function logout() {
            if(confirm("¿Estás seguro de que deseas cerrar sesión?")) {
                localStorage.clear();
                window.location.href = '../index.html';
            }
        }
    </script>
</body>
</html>